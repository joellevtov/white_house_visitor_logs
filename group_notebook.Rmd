---
title: "R Notebook"
output: html_notebook
---

---
title: "R Notebook"
authors: Taylor, Menna, Shaun, Joel
output: html_notebook
---

Memo link: https://docs.google.com/document/d/1j_19XNibAk0Modj5MFnaPfIz1M4JZ1dzW1s5KP2PIQM/edit?usp=sharing 

```{r}
library(tidyverse)
library(janitor)
library(lubridate)
```

```{r}
###asked chatgpt how to turn a character column into a date time column, gave it some examples from our code and int told me to do this:
wh_visitor_data <- read_csv("data/combined.csv") |> clean_names() |>
  mutate(toa = mdy_hm(toa)) |>
  mutate(tod = mdy_hm(tod)) |>
  mutate(appt_made_date = mdy_hm(appt_made_date))  |>
  mutate(appt_start_date = mdy(appt_start_date))  |>
  mutate(appt_end_date = mdy_hm(appt_end_date))  |>
  mutate(lastentrydate = mdy_hm(lastentrydate))  |>
  mutate(releasedate = mdy(releasedate)) 
  
```

Let's take a quick look at the data now that we've changed these columns into dates.

```{r}
glimpse(wh_visitor_data)
```

Here are our new questions we'd like to answer: What are the most popular times / dates / months for White House visitors and how do they correlate with important political events? Has the amount of visitors fluctuated during Biden presidency (see if this correlates with rise in drop of approval rating) West Wing Tours are selective, how many are being taken? Who has sponsored the most White House visitors - e.g. who is getting the most visitors? What percent of visitors have just been labeled "office visitors"? If it's a significant percentage, that would seem to defeat the point of releasing these logs. Not much better than the Trump administration.

Immediate limitations: 1. There are a lot of NAs in here where dates should go. I think the most reliable date is the appointment end date, which means the times are probably useless for us. 2. Dates and times aren't always written the same way. Is that going to cause us problems? We should probably check with Derek about that. 3. We wanted to look at how many folks are labeled office visitor - we're gonna have to find all instances of that, they're not marked the same. 4. We had a question about west wing visits. I don't see any identifying data here to show which ones are west wing visits, although there are a lot of confusing column names and abbreviations. 5. There are a ot of confusing column names and abbreviations - we will need to dig deeper into that to find out what we can actually look at here. 6. I still really want to know what types of people are visiting. Could we at least match congress people up using the propublica dataset and see how many folks are not house or senate members? We may be able to find a dataset of foreign powers we can match up as well.

```{r}
# We want a clean single dataframe to work with. Right now there are a lot of columns that might not be particularly interesting or useful. For example, let's get rid of x28 and x29, caller room, appt cancel date, terminal suffix, poa, tod, pod,  meeting room, and post.

clean_wh_visitor_data <- wh_visitor_data |>
  select(-poa, -access_type, -pod, -appt_cancel_date, -caller_room, -uin, -bdgnbr, -last_updatedby, -post, -terminal_suffix,-caller_name_last, -caller_name_first)

# Full transparency, I couldn't remember the code for deleting a column so I asked ChatGPT the following: "using the tidyverse, janitor, and lubridate libraries in R, how do I delete a column?"
```

Let's see when the most popular day for visiting was. To do that, first we're going to create new columns with only the dates.

```{r}
###note - we were having problems with this so I asked chatgpt: how do I make a new column with just the date from a column that includes date and time using lubridate and the tidyverse? it told me to do mutate(toa_date = ymd_hms(toa) %>% date())

clean_wh_visitor_data <- clean_wh_visitor_data |>
  mutate(toa_date = ymd_hms(toa) |> date()) |>
  mutate(tod_date = ymd_hms(tod) |>date())
```

```{r}
####mutate(toa_time = ymd_hms(toa) |> time()) we need to figure out how to separate out time from these two columns as well

clean_wh_visitor_data |>
  group_by(toa_date) |> 
  summarize(count=n()) |>
  arrange(desc(count))
  
# note - since there are so many NA dates here, I think we should group by appt date.

wh_visitors_by_date <- clean_wh_visitor_data |>
  group_by(appt_start_date) |>
  summarize(total_visits = n()) |>
  arrange(desc(total_visits))

### just kidding, there are a ton of NA dates still. maybe appt end date?

wh_visitors_by_end_date <- clean_wh_visitor_data |>
  group_by(appt_end_date) |>
  summarize(total_visits = n()) |>
  arrange(desc(total_visits))

### this seems better
```


```{r}
###derek asked if the NA dates were specific to certain offices. how do we figure that out?

clean_wh_visitor_data |> filter(if_any(-toa_date, is.na)) |>
  group_by(meeting_loc) |>
  summarise(count = n())
```

1.  What are the most popular months and dates? What political events correlate with those? 

```{r}

###mutate(toa_time = ymd_hms(toa) |> time()) we need to figure out how to separate out time from these two columns as well

clean_wh_visitor_data |>
  group_by(toa_date) |> 
  summarize(count=n()) |>
  arrange(desc(count))
  
# note - since there are so many NA dates here, I think we should group by appt date.

wh_visitors_by_date <- clean_wh_visitor_data |>
  group_by(appt_start_date) |>
  summarize(total_visits = n()) |>
  arrange(desc(total_visits))

### just kidding, there are a ton of NA dates still. maybe appt end date?

wh_visitors_by_end_date <- clean_wh_visitor_data |>
  group_by(appt_end_date) |>
  summarize(total_visits = n()) |>
  arrange(desc(total_visits))

# July 2 calculation
wh_visitor_data |> 
  filter(str_detect(appt_end_date, "2023-07-02")) |> 
  group_by(date) |> 
  summarize(sum= sum(total_people)) 
# so 1994 people visited the white house on that date. let's check what the average amount of people on mondy is.
wh_visitor_data |> 
  mutate(day_of_week = wday(appt_end_date)) |> 
  filter(day_of_week == 1) |> 
  group_by(appt_end_date) |> 
  summarize(total_people = sum(total_people)) |> 
  filter(!is.na(total_people)) |> 
  summary(round(total_people))

wh_visitors_per_day <- wh_visitor_data |> 
  mutate(date = date(appt_end_date)) |> 
  group_by(date) |> 
  summarize(total_people = sum(total_people)) |> 
  filter(!is.na(total_people)) 

class(wh_visitors_per_day$date)
  
#answer - 33801 is the average number of visitors via the mean but that's thrown off by a couple days with an insanely high number of visitors. the median is more reasonable, 139. 	
# funny. let's make a scatterplot with a line of best fit to see what the distribution is. perhaps the number of visitors has increased as time as went on?
ggplot(data=wh_visitors_per_day) +
  geom_point(aes(x=date, y=total_people))

# It looks like the answer is not really. The days with tens of thousands of people seem to be big outliers. 
```

Top 5 Dates: 

1. 06-22-2023: President Biden and Prime Minister Modi of the Republic of India in Joint Press Conference
2. 12-23-2022: President Biden passes a successful bipartisan funding bill
3. 04-26-2023:President Biden and President Yoon Suk Yeol of the Republic of Korea to commemorate the 70th anniversary of their alliance
4. 07-04-2023: Independence Day event at the White House hosted by President Biden and First Lady Jill Biden (recurring date with a big total of visitors)
5. 12-13-2022: President Biden signs the Respect for Marriage Act, legalizing gay marriage

Another important date: July 2, the day cocaine was found in the White House.

This is actually pretty interesting! It's somewhat surprising that the top date doesn't solely have to do with the United States itself, but I remember driving through Capitol Hill several times that week and seeing the huge impact (both good and bad) that Modi's visit had on the city. The majority of these highest visited dates correlate with important international visits, United States-specific holidays, and the passage of significant things into law.

We think it may actually be more interesting to look at data where groups were less than 100 because those may be attributed to big events or holidays, which we could have guessed. What are the most popular dates and months for regular folks?

```{r}
clean_wh_visitor_data |>
  group_by(appt_end_date) |> 
  filter(total_people <100) |>
  summarize(count=n()) |>
  arrange(desc(count))
```
Top 5 Dates: 

1. 12-23-2022: President Biden passes a successful bipartisan funding bill
2. 03-18-2023: literally NO idea nothing is showing up (pls help)
3. 05-11-2023: This was a big day at The House because the Biden-Harris Administration made a lot of big decisions about Global Health, Environmental Protection and National Conservation, Immigration, and International/National Emergency Funding
4. 03-25-2023: President Biden and President Alberto Fernandez of Argentina 
5. 05-12-2023: Continuation of the decisions made on 5/11, as well as the start of Infrastructure Week.

This is so interesting because, aside from 12/23, none of the dates repeat in the data without big organized groups. This shows that big organized groups frequently visit on holidays and days with big international repercussions, while more national-focused events and big decisions are primarily attended by individuals or folks in smaller groups.

2.  Has the amount of visitors fluctuated during Biden presidency (see if this correlates with rise in drop of approval rating)

```{r}
### Note - asked ChatGPT how to make the month column have labels and gave it my mutate code creating a new col with lubridate
#reading in approval ratings data from gallup
approval_ratings <- read_csv("data/biden_approval_gallup.csv", col_names = FALSE)

colnames(approval_ratings) <- c("poll_date", "rep_approval_pct", "ind_approval_pct", "dem_approval_pct")
  
approval_ratings <- approval_ratings |>
  separate(poll_date, into = c("year", "month", sep = "-")) |>
  select(year, month, rep_approval_pct, ind_approval_pct, dem_approval_pct)

approval_ratings <- approval_ratings |>
  mutate(date = paste(year, month, sep = " "))

#making a df with top months for visitors
wh_visitor_by_month <- wh_visitors_by_end_date |> 
 mutate(date_time = ymd_hms(appt_end_date),
  month = month.abb[month(appt_end_date)])

wh_visitor_by_month <- wh_visitor_by_month |>
  group_by(month) |>
  summarise(total_visits = sum(total_visits))

#last one not really helpful bc didn't sort by year. Now doing the same with year and month
wh_visitors_month_year <- wh_visitors_by_end_date |> 
 mutate(date_time = ymd_hms(appt_end_date),
  month = month.abb[month(appt_end_date)],
  year = year(date_time))

top_months_by_year <- wh_visitors_month_year |>
  group_by(year, month) |>
   summarise(total_visits = sum(total_visits))
```

```{r}
#not sure if that was useful. I think I need to join these dataframes. Asked chatgpt for help with this because I needed to join on the date column and didn't have one with year and month in it for top_months_by_year. Asked it: I want to create a date column that looks like this: 2022 Jan, 2022 Feb, 2022 March. Currently I have a year column that looks like this: 2022, 2022, 2022, and a month column that looks like this: Jan, Feb, March. How can I create this new column using r and the tidyverse?

top_months_by_year <- top_months_by_year |>
    mutate(date = as.Date(paste(year, month, "01"), format = "%Y %b %d"))

approval_ratings <- approval_ratings |>
  mutate(date = as.Date(paste(year, month, "01"), format = "%Y %b %d"))

visits_by_month_ratings <- top_months_by_year |> 
  left_join(approval_ratings, by = "date") |>
  rename(year = year.x, month = month.x) |>
  select(-year.y, -month.y) |>
  na.omit(visits_by_month_ratings)
```


```{r}
#note - chatgpt wrote this code for me, I wanted to put these on the same graph but couldn't figure out the scale part
library(ggplot2)
ggplot(visits_by_month_ratings, aes(x = date)) +
  # Bar chart for total_visits
  geom_bar(aes(y = total_visits), stat = "identity", fill = "darkgray") +
  # Line graphs for approval_ratings
  geom_line(aes(y = dem_approval_pct * max(total_visits) / max(dem_approval_pct)), color = "blue") +
  geom_line(aes(y = ind_approval_pct * max(total_visits) / max(dem_approval_pct)), color = "darkgreen") +
  geom_line(aes(y = rep_approval_pct * max(total_visits) / max(dem_approval_pct)), color = "red") +
  # Y-axis scale for total_visits
  scale_y_continuous(name = "Total Visits", breaks = seq(0, 70000, by = 10000)) +
  # Secondary Y-axis scale for approval_rating
  scale_y_continuous(
    name = "Total Visits",
    sec.axis = sec_axis(~ . * max(visits_by_month_ratings$dem_approval_pct) / max(visits_by_month_ratings$total_visits), name = "Dem Approval Rating")
  ) +
  theme_gray()

#note - not sure if this is actually a valuable graph. Should we just throw out 2021 data because it's so sparse compared to 2022/23? Does this highlight fluctuations in visits or just a lack of data for earlier months? Also it wouldn't graph Dec 2022 which was the second highest month because of NA values in the approval ratings. @DEREK is there a way around this?
```

3.  West Wing Tours are selective, how many are being taken?

```{r}

```

4.  Who has sponsored the most White House visitors?
This won't load properly because we have to upload the file and I missed a potus column when I was cleaning, but after office visitors, it's Biden, then Ed Teleky (17k visitors) and then Gionelly Mills (almost 13k visits).
```{r}
open_refine_cleaned_visitors <- read_csv("data/open_refined_wh_data_combined.csv")

open_refine_cleaned_visitors |> group_by(VISITEE_NAMELAST_CLEAN, VISITEE_NAMEFIRST_CLEAN) |>
  summarise(visits = n()) |>
  arrange(desc(visits))
```

5.  What percent of visitors have just been labeled "office visitors"?

```{r}
wh_visitor_data %>%
  filter(str_detect(visitee_namelast, regex("office", ignore_case = TRUE))) |> 
  filter(str_detect(visitee_namefirst, regex("visitors", ignore_case = TRUE))) |> 
  summarize(count = n())  
# result - 462349 entries with just that office visitors bs
  
462349/847371
```

6.  How often are specific people visiting? AI people? Things they want to regulate? Pick who we want to look at.

Let's see if we can find whether OpenAI lobbyists visited the president. According to Politico, there are the handful of lobbyists the company has:- Tony Samp- Chan ParkThe Politico story says that those two only started as OpenAI lobbyists in October so that doesn't help us.Let's try looking for the CEO, Samuel H Altman.

```{r}
clean_wh_visitor_data |> 
  filter(
    str_detect(namelast, regex("altman", ignore_case = TRUE))
    &
    str_detect(namefirst, regex("^sam", ignore_case=TRUE))
         )
```

That shows us Samuel Altman.Makes sense.But what escapes me is that there is a Samuel N Altman and a Samuel H Altman.Theoretically, these should be two different people but when I search "samuel n altman -openai" with google, I get an Ancestry.com record for someone who was counted in the 1940 census, Samuel Altman the shift leader at Wallgreens, Samuel Altman the landscaper, Samuel Altman the president of a bio-nutrition labratory and Samuel Altman the lawyer in Georgia.None of those seem likely to visit the White House so it might just be a typographical error.Anyhow, assuming all of them are Samuel Altman, CEO of OpenAI: